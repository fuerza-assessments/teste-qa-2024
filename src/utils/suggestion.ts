export type SuggestionType = 'mention' | 'emoji'

export const getSuggestionData = (
	textareaEl: HTMLTextAreaElement,
): {
	keystrokeTriggered: boolean
	triggerIdx: number
	type: SuggestionType
	query: string
} => {
	const positionIndex = textareaEl.selectionStart
	const textBeforeCaret = textareaEl.value.slice(0, positionIndex)

	const tokens = textBeforeCaret.split(/\s/)
	const lastToken = tokens[tokens.length - 1]

	if (!lastToken) {
		return {
			keystrokeTriggered: false,
			triggerIdx: -1,
			type: 'mention',
			query: '',
		}
	}

	const triggerIdx = textBeforeCaret.endsWith(lastToken ?? '') ? textBeforeCaret.length - lastToken.length : -1

	const maybeTrigger = textBeforeCaret[triggerIdx]
	const mentionKeystrokeTriggered = maybeTrigger === '@'
	const emojiKeystrokeTriggered = maybeTrigger === ':'
	const keystrokeTriggered = mentionKeystrokeTriggered || emojiKeystrokeTriggered
	const type = mentionKeystrokeTriggered ? 'mention' : 'emoji'

	const query = textBeforeCaret.slice(triggerIdx + 1)

	return {
		keystrokeTriggered,
		triggerIdx,
		type,
		query,
	}
}
